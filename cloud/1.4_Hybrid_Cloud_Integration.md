# Phase 1.4: 하이브리드 클라우드 통합 (Proxmox + AWS)

**문서 최종 수정일:** 2025년 11월 29일

## 1. 개요

온프레미스(On-premise)에 구축한 Proxmox VE 서버와 아마존 웹 서비스(AWS)를 연동하여 하이브리드 클라우드 환경을 구축합니다. 이 단계의 목표는 AWS의 강력한 스토리지 및 네트워크 서비스를 활용하여 데이터 백업의 안정성을 높이고, 향후 서비스 확장을 위한 기반을 마련하는 것입니다.

## 2. AWS 계정 및 IAM 사용자 생성

### 2.1. AWS 계정 생성
1.  AWS 공식 홈페이지([https://aws.amazon.com/ko/](https://aws.amazon.com/ko/))에 접속하여 '새 AWS 계정 생성'을 진행합니다.
2.  이메일 주소, 암호, 연락처 정보, 신용카드 정보를 입력하여 가입을 완료합니다. (초기 12개월간 프리 티어 제공)
3.  계정 생성 후, 루트 사용자가 아닌 관리자 권한을 가진 IAM 사용자를 생성하여 사용하는 것이 보안상 권장됩니다.

### 2.2. 백업 전용 IAM 사용자 생성
Proxmox Backup Server가 S3 버킷에 접근할 수 있도록 최소한의 권한을 가진 사용자를 생성합니다.

1.  AWS Management Console에 로그인 후, 서비스 검색창에 `IAM`을 입력하여 이동합니다.
2.  왼쪽 메뉴에서 `사용자`를 선택하고 `사용자 생성` 버튼을 클릭합니다.
3.  **1단계 (사용자 세부 정보 지정):**
    - `사용자 이름`: `proxmox-backup-user` 입력.
    - `다음` 클릭.
4.  **2단계 (권한 설정):**
    - `직접 정책 연결`을 선택합니다.
    - `권한 정책` 섹션에서 `정책 생성`을 클릭합니다.
5.  **정책 생성:**
    - 새 창에서 `JSON` 탭을 선택하고 아래의 정책 코드를 붙여넣습니다. `iksan-cloud-backup-20251129` 부분은 실제 생성할 버킷 이름으로 수정해야 합니다.
    ```json
    {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Effect": "Allow",
                "Action": [
                    "s3:PutObject",
                    "s3:GetObject",
                    "s3:DeleteObject",
                    "s3:ListBucket",
                    "s3:GetBucketLocation"
                ],
                "Resource": [
                    "arn:aws:s3:::iksan-cloud-backup-20251129",
                    "arn:aws:s3:::iksan-cloud-backup-20251129/*"
                ]
            }
        ]
    }
    ```
    - `다음: 태그` -> `다음: 검토` 클릭.
    - `이름`: `Proxmox-S3-Backup-Policy` 입력 후 `정책 생성`.
6.  다시 **IAM 사용자 생성** 창으로 돌아와서, 방금 생성한 `Proxmox-S3-Backup-Policy`를 검색하여 체크하고 `다음` 클릭.
7.  **3단계 (검토 및 생성):** 내용을 확인하고 `사용자 생성`을 완료합니다.
8.  생성된 사용자(`proxmox-backup-user`)를 클릭하고 `보안 자격 증명` 탭으로 이동합니다.
9.  `액세스 키` 섹션에서 `액세스 키 만들기` -> `커맨드 라인 인터페이스(CLI)` 선택 -> `만들기`.
10. **액세스 키 ID**와 **비밀 액세스 키**를 즉시 복사하여 안전한 곳(예: 비밀번호 관리자)에 저장합니다. **이 창을 벗어나면 비밀 키를 다시 확인할 수 없습니다.**

## 3. AWS S3 버킷 생성 (백업 저장소)

1.  AWS 서비스 검색창에서 `S3`를 입력하여 이동합니다.
2.  `버킷 만들기`를 클릭합니다.
3.  **일반 구성:**
    - `버킷 이름`: 전 세계적으로 고유해야 합니다. (예: `iksan-cloud-backup-20251129`)
    - `AWS 리전`: `아시아 태평양(서울) ap-northeast-2` 선택.
4.  **객체 소유권:** `ACL 비활성화됨(권장)` 선택.
5.  **이 버킷의 퍼블릭 액세스 차단 설정:** `모든 퍼블릭 액세스 차단`을 체크된 상태로 유지합니다. (보안 강화)
6.  **버킷 버전 관리:** `활성화`를 선택하여 실수로 인한 데이터 삭제/덮어쓰기를 방지합니다.
7.  **기본 암호화:** `활성화` 선택, `Amazon S3 관리형 키(SSE-S3)` 유지.
8.  `버킷 만들기`를 클릭하여 생성을 완료합니다.

## 4. Proxmox Backup Server(PBS)와 S3 연동

Proxmox VE와 별도로 Proxmox Backup Server(PBS)를 설치하여 백업을 중앙 관리하고, S3와 효율적으로 연동합니다.

1.  **PBS용 VM 생성:** Proxmox VE 웹 인터페이스에서 `node1`에 새 VM을 생성합니다. (사양: 2코어, 4GB RAM, 50GB 디스크)
2.  **PBS 설치:** Proxmox 공식 사이트에서 PBS ISO를 다운로드하여 해당 VM에 설치합니다. (설치 과정은 PVE와 유사)
3.  **S3를 원격 스토리지로 추가 (PBS 웹 인터페이스):**
    1.  PBS 웹 인터페이스(`https://<PBS의 IP>:8007`)에 접속.
    2.  `Configuration` -> `Remotes` -> `Add`.
    3.  `ID`: `aws-s3-storage` 입력.
    4.  `Endpoint`: `s3.ap-northeast-2.amazonaws.com` 입력.
    5.  `Bucket`: 위에서 생성한 S3 버킷 이름 (`iksan-cloud-backup-20251129`) 입력.
    6.  `Access Key ID`: IAM 사용자 생성 시 발급받은 액세스 키 ID 붙여넣기.
    7.  `Secret Access Key`: 발급받은 비밀 액세스 키 붙여넣기.
    8.  `Add` 클릭.
4.  **데이터스토어 생성:**
    1.  `Datastore` 메뉴로 이동하여 `Add Datastore` 클릭.
    2.  `Name`: `vm-backup-s3` 입력.
    3.  `Backing Storage`: 방금 추가한 `aws-s3-storage` 선택.
    4.  `Add` 클릭.
5.  **PVE에 PBS 스토리지 추가:**
    1.  Proxmox VE 웹 인터페이스(`https://<PVE의 IP>:8006`)로 이동.
    2.  `데이터센터` -> `스토리지` -> `추가` -> `Proxmox Backup Server`.
    3.  `ID`: `pbs-main` 입력.
    4.  `서버`: PBS의 IP 주소 입력.
    5.  `사용자 이름`: `root@pam` 입력.
    6.  `암호`: PBS의 root 암호 입력.
    7.  `Datastore`: `vm-backup-s3` 선택.
    8.  `추가` 클릭. 이제 PVE에서 VM 백업 시 대상 스토리지로 PBS(및 S3)를 선택할 수 있습니다.

## 5. Site-to-Site VPN 연결 (선택적 심화 과정)

*이 단계는 초기 MVP에는 필수는 아니지만, 향후 AWS의 다른 서비스(EC2, RDS 등)와 온프레미스 서버 간의 안전한 내부 통신이 필요할 경우를 대비한 구축 과정입니다.*

1.  **가상 방화벽 설치:** Proxmox VE에 OPNsense 또는 pfSense 방화벽 VM을 설치하고, KT 모뎀과 내부 네트워크 사이의 게이트웨이로 작동하도록 네트워크를 구성합니다.
2.  **AWS VPN 설정:**
    - AWS VPC 콘솔 -> `Site-to-Site VPN 연결` -> `VPN 연결 생성`.
    - `가상 프라이빗 게이트웨이`를 생성하여 VPC에 연결합니다.
    - `고객 게이트웨이`를 생성하고, 온프레미스 방화벽의 공인 IP 주소를 등록합니다.
    - 두 게이트웨이를 사용하여 VPN 연결을 생성하고, 라우팅 옵션을 '정적'으로 하여 온프레미스 내부 IP 대역(`192.168.0.0/24` 등)을 추가합니다.
3.  **OPNsense/pfSense 설정:**
    - AWS에서 제공하는 VPN 구성 파일을 다운로드합니다.
    - OPNsense/pfSense의 `VPN` -> `IPsec` 메뉴에서 다운로드한 파일의 정보를 바탕으로 Phase 1(IKE), Phase 2(ESP) 터널 설정을 완료합니다. (인증 방식, 암호화 알고리즘, Pre-Shared Key 등)
4.  **연결 확인:** AWS 콘솔에서 VPN 터널 상태가 `Up`으로 변경되고, 온프레미스 서버에서 AWS VPC 내에 생성한 EC2 인스턴스의 사설 IP로 `ping`이 성공하면 연결이 완료된 것입니다.

---
## 6. 다음 단계
- `[1.5_MVP_Service_Launch.md](1.5_MVP_Service_Launch.md)` 로 이동하여 고객에게 제공할 실제 서비스(웹 호스팅, VPS)를 구축하고 출시 준비를 합니다.
