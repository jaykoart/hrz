# 1.4. 하이브리드 클라우드 & 네트워크 연동 (Dual Overlay Network)

**문서 버전:** 2.0 (Earth AI Strategy Aligned)
**최종 업데이트:** 2025년 12월 8일
**핵심 목표:** 자체 **마이크로 데이터센터(Core)**와 **글로벌 엣지(Edge)**를, **P2P 네트워크(User Nodes)**와 안전하게 연결하는 삼각 편대 구축.

---

## 1. 네트워크 아키텍처: 이중 오버레이 (Dual Overlay)

### 1.1. 개념 (Concept)
보안과 성능을 위해 네트워크를 두 개의 층(Layer)으로 분리합니다.
*   **Layer 1 (Control Plane):** 관리 및 보안 통신용. (Headscale / Tailscale 기반)
*   **Layer 2 (Data Plane):** 실제 대용량 데이터 전송용. (Cloudflare / Residential IP)

### 1.2. 핵심 기술 스택 (Tech Stack)
*   **P2P VPN Control:** **Headscale** (오픈소스 Tailscale 컨트롤러).
    *   *이유:* Tailscale 부분 유료화 회피 및 사용자 데이터 주권 확보. 무제한 노드 연결 가능.
*   **Edge Routing:** **Cloudflare Tunnel (Argo Tunnel)**.
    *   *이유:* 로컬 서버(익산)에 공인 IP가 없거나 방화벽 뒤에 있어도 외부 접속 가능. DDoS 방어 무료 제공.
*   **Reverse Proxy:** **Nginx Proxy Manager** or **Traefik**.
    *   *이유:* SSL 인증서 자동 갱신 및 내부 서비스 로드 밸런싱.

---

## 2. 구축 가이드 (Implementation)

### 2.1. Headscale 서버 구축 (in Proxmox)
*   사용자(VPN 앱)들이 서로 연결되기 위한 '신호등' 역할을 합니다.
*   **설치:** Ubuntu 24.04 컨테이너(LXC)에 Docker로 Headscale 설치.
*   **도메인 연결:** `vpn.your-earth-domain.com`을 Cloudflare Tunnel을 통해 Headscale 서버와 연결.
*   **기능:**
    *   **ACL(접근 제어):** 유료/무료 유저 간 트래픽 격리.
    *   **Exit Node:** 특정 국가(노드)를 출구로 지정하여 우회 접속 가능하게 함.

### 2.2. Cloudflare Tunnel 연동
*   **목적:** 익산 서버실의 포트(80, 443, SSH)를 외부에 안전하게 개방.
*   **설정:**
    1.  Proxmox 내부에 `cloudflared` 데몬 설치.
    2.  Cloudflare Dashboard에서 터널 생성 및 토큰 발급.
    3.  `config.yml` 설정:
        ```yaml
        ingress:
          - hostname: api.your-earth-domain.com
            service: http://localhost:8080 (내부 API 서버)
          - hostname: ssh.your-earth-domain.com
            service: ssh://localhost:22
        ```

### 2.3. S3 호환 스토리지 연동 (Data Lake)
*   데이터 수집 시 대용량 저장소가 필요합니다.
*   **MinIO (Self-hosted S3):** 로컬 서버 HDD에 설치. AWS S3 API와 100% 호환.
*   **구조:** 
    *   Hot Data (최근): MinIO (로컬 서버) -> 속도 빠름, 비용 0원.
    *   Cold Data (오래됨): Cloudflare R2 (클라우드) -> 전송료 무료 아카이빙.

---

## 3. 스마트팜/IoT 센서 연동 (For Farm AI)
농장(Farm)의 데이터를 실시간으로 수집하기 위한 엣지 네트워크 구성.

*   **프로토콜:** MQTT (경량 메시징).
*   **게이트웨이:** 라즈베리 파이(RPi)를 농장에 설치 -> WireGuard로 익산 본섭과 연결.
*   **보안:** VPN 터널링을 통해 CCTV 영상 등 민감한 농장 데이터가 공용 인터넷에 노출되지 않도록 암호화 전송.

---

## 4. 체크리스트
- [ ] 도메인 구입 (Namecheap/Cloudflare) 및 Cloudflare DNS 등록.
- [ ] Headscale 도커 컨테이너 구축 및 테스트 사용자 연결 확인.
- [ ] Cloudflare Tunnel을 통해 외부에서 로컬 Proxmox 대시보드 접속 성공 여부 확인.
